name: Update files with commit

on:
  push:
    tags:
      - v*.*.*

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master

      - name: Capture version in README.md
        id: file
        run: |
          repo_name=$(basename "$GITHUB_REPOSITORY")
          cap=$(grep -oP "${repo_name}-\Kv\d\.\d\.\d[^\s]*" README.md)
          echo "version=$cap"  >> "$GITHUB_OUTPUT"
          echo "repo_name=$repo_name"  >> "$GITHUB_OUTPUT"

      - name: Capture version in latest tag
        id: tag
        run: echo "version=$(git tag -l "v*"|tail -n1)" >> "$GITHUB_OUTPUT"

      - name: Substitute version in README.md
        id: sub
        if: ${{ steps.file.outputs.version }} != ${{ steps.tag.outputs.version }}
        run: sed -i 's/${{ steps.file.outputs.repo_name}}-${{ steps.file.outputs.version }}/${{ steps.file.outputs.repo_name}}-${{ steps.tag.outputs.version }}/g' README.md

      - name: Push changes
        if: steps.sub.conclusion == 'success'
        uses: EndBug/add-and-commit@v9
        with:
          committer_name: GitHub Actions
          committer_email: actions@github.com
          tag: '${{ steps.tag.outputs.version }} --annotate -m "Version bump to ${{ steps.tag.outputs.version }}" --force'
          message: "Update version in file."
          tag_push: "--force"

  # publish:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         token: ${{ secrets.GITHUB_TOKEN }} # You need to create your own token with commit rights
  #         ref: master # The branch you want to commit to

  #     - name: Push changes
  #       uses: EndBug/add-and-commit@v9
  #       with:
  #         committer_name: GitHub Actions
  #         committer_email: actions@github.com
  #         add: .
  #         message: "update files"
