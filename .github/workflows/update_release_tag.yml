name: Update files with commit

on:
  push:
    tags:
      - v*.*.*

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master

      - name: Check version in README.md
        id: file
        run: echo "version=$(cat README.md | grep -Eo git_practice-v[0-9]+\.[0-9]+\..+ | sed 's/^git_practice-//g')"  >> "GITHUB_OUTPUT"

      - name: tag version
        id: tag
        run: echo "version=$(git tag -l "v*"|tail -n1)" >> "GITHUB_OUTPUT"

      - name: Prune tags from remote
        if: ${{ steps.file.outputs.version }} != ${{ steps.tag.outputs.version }}
        uses: EndBug/add-and-commit@v9
        with:
          committer_name: GitHub Actions
          committer_email: actions@github.com
          add: .
          tag: "${{ steps.tag.outputs.version }} -d"
          tag_push: "--prune"

      - name: Substitute
        id: sub
        if: ${{ steps.file.outputs.version }} != ${{ steps.tag.outputs.version }}
        run: sed -i 's/git_practice-${{ steps.file.outputs.version }}/git_practice-${{ steps.tag.outputs.version }}/g' README.md

      - name: Push changes
        if: steps.sub.conclusion == 'success'
        uses: EndBug/add-and-commit@v9
        with:
          committer_name: GitHub Actions
          committer_email: actions@github.com
          add: .
          tag: "${{ steps.tag.outputs.version }} -a"
          message: "Update version in file."
          push: "--follow-tags"

  # publish:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         token: ${{ secrets.GITHUB_TOKEN }} # You need to create your own token with commit rights
  #         ref: master # The branch you want to commit to

  #     - name: Push changes
  #       uses: EndBug/add-and-commit@v9
  #       with:
  #         committer_name: GitHub Actions
  #         committer_email: actions@github.com
  #         add: .
  #         message: "update files"
